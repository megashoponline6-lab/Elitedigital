<div id="ticket" style="max-width:700px;margin:30px auto;padding:30px;border-radius:20px;background:#121212;color:#fff;box-shadow:0 0 20px rgba(0,0,0,0.5);font-family:'Segoe UI',sans-serif;">

  <% if (sess && sess.admin) { %>
    <div style="background:#e50914;color:white;padding:10px 15px;border-radius:10px;margin-bottom:20px;text-align:center;font-weight:600;">
      👁️ Vista de administrador — Ticket perteneciente a 
      <%= suscripcion.userId ? (suscripcion.userId.correo || suscripcion.userId.toString()) : 'Usuario desconocido' %>
      <br>
      <button onclick="window.location.href='/admin/suscripciones'" style="margin-top:8px;padding:6px 12px;border:none;border-radius:8px;background:#fff;color:#e50914;cursor:pointer;font-weight:600;">
        ⬅️ Volver al Panel Admin
      </button>
    </div>
  <% } %>

  <div style="text-align:center;">
    <% if (plataforma.logoUrl) { %>
      <img 
        src="<%= plataforma.logoUrl.startsWith('/') ? plataforma.logoUrl : '/' + plataforma.logoUrl %>" 
        alt="<%= plataforma.name %>" 
        style="max-height:90px;margin-bottom:10px;"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
        onerror="this.src='/img/plataformas/default.png'">
    <% } %>
    <h2 style="margin:10px 0;color:#e50914;">🎟️ Ticket de Compra</h2>
    <p style="color:#bbb;">Gracias por confiar en <strong style="color:#fff;">Eliteflix</strong></p>
  </div>

  <hr style="margin:20px 0;border-color:#333;">

  <p><strong>🎬 Plataforma:</strong> <span style="color:#e50914;"><%= plataforma.name %></span></p>
  <p><strong>⏱️ Duración:</strong> <%= suscripcion.meses %> mes<%= suscripcion.meses > 1 ? 'es' : '' %></p>

  <div style="margin-top:15px;">
    <p><strong>📧 Correo asignado:</strong> 
      <span id="correo" style="background:#222;padding:5px 10px;border-radius:6px;color:#fff;">
        <%= suscripcion.datosCuenta?.correo || 'No disponible' %>
      </span>
      <button onclick="copiar('correo')" style="margin-left:5px;padding:5px 10px;border:none;border-radius:6px;background:#e50914;color:white;cursor:pointer;">Copiar</button>
    </p>

    <p><strong>🔑 Contraseña:</strong> 
      <span id="password" style="background:#222;padding:5px 10px;border-radius:6px;color:#fff;">
        <%= suscripcion.datosCuenta?.password || 'No disponible' %>
      </span>
      <button onclick="copiar('password')" style="margin-left:5px;padding:5px 10px;border:none;border-radius:6px;background:#e50914;color:white;cursor:pointer;">Copiar</button>
    </p>
  </div>

  <div style="margin-top:25px;background:#1e1e1e;padding:15px 20px;border-left:5px solid #e50914;border-radius:10px;">
    <p style="margin:0 0 8px 0;"><strong>💬 Mensaje del administrador:</strong></p>
    <p style="margin:0;color:#ddd;white-space:pre-line;"><%= mensaje %></p>
  </div>

  <div style="margin-top:25px;">
    <p><strong>📅 Fecha de inicio:</strong> <%= dayjs(suscripcion.fechaInicio).format('DD/MM/YYYY') %></p>
    <p><strong>⏳ Fecha de fin:</strong> <%= dayjs(suscripcion.fechaFin).format('DD/MM/YYYY') %></p>
  </div>

  <div style="text-align:center;margin-top:35px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap;">
    <% if (sess && sess.admin) { %>
      <button onclick="window.location.href='/admin/suscripciones'" style="padding:10px 20px;border:none;border-radius:10px;background:#333;color:#fff;cursor:pointer;font-weight:600;">
        ⬅️ Volver al Panel Admin
      </button>
    <% } else { %>
      <button onclick="window.location.href='/panel'" style="padding:10px 20px;border:none;border-radius:10px;background:#333;color:#fff;cursor:pointer;font-weight:600;">
        ⬅️ Volver al Panel
      </button>
    <% } %>

    <button id="btnPDF" style="padding:10px 20px;border:none;border-radius:10px;background:#e50914;color:#fff;cursor:pointer;font-weight:600;">
      📄 Descargar Ticket (PDF)
    </button>
  </div>

  <div style="margin-top:40px;text-align:center;color:#888;font-size:13px;">
    <p>Eliteflix © <%= new Date().getFullYear() %> — Todos los derechos reservados</p>
  </div>
</div>

<!-- 📦 Librería para convertir HTML a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
function copiar(id) {
  const texto = document.getElementById(id).innerText.trim();
  navigator.clipboard.writeText(texto).then(() => {
    alert('Copiado: ' + texto);
  });
}

// ✅ Generar PDF sin recortes, compatible con móvil, PC y tablets
document.getElementById('btnPDF').addEventListener('click', async () => {
  const ticket = document.getElementById('ticket');
  const fecha = new Date().toISOString().slice(0, 10);
  const nombreArchivo = `${'<%= plataforma.name.replace(/\\s+/g, "_") %>'}_${fecha}.pdf`;

  // Esperar que las imágenes carguen
  const imagenes = ticket.querySelectorAll('img');
  await Promise.all(Array.from(imagenes).map(img => new Promise(resolve => {
    if (img.complete) return resolve();
    img.onload = resolve;
    img.onerror = () => {
      img.src = '/img/plataformas/default.png';
      resolve();
    };
  })));

  // Forzar scroll arriba (evita recorte en móviles)
  window.scrollTo({ top: 0, behavior: 'instant' });

  // Configuración ajustada
  const opt = {
    margin: 0.3,
    filename: nombreArchivo,
    image: { type: 'jpeg', quality: 0.95 },
    html2canvas: {
      scale: window.innerWidth < 768 ? 2 : 3, // móviles usan menos escala
      useCORS: true,
      allowTaint: false,
      scrollY: 0,
      backgroundColor: '#121212'
    },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  try {
    await html2pdf().set(opt).from(ticket).save();
  } catch (err) {
    console.error('Error al generar PDF:', err);
    alert('Hubo un error al generar el PDF. Intenta de nuevo.');
  }
});
</script>
