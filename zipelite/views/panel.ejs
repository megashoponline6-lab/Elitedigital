<% layout = 'layout' %>
<% var title = 'Mi Panel'; %>

<style>
  body {
    background: linear-gradient(135deg, #0a0a0f 40%, #120028);
    color: #e0e0e0;
  }

  h2, h3, h5 {
    color: #fff;
    text-shadow: 0 0 10px #ff003c, 0 0 20px #ff003c;
  }

  .neon-box {
    background: rgba(20, 20, 30, 0.75);
    border: 1px solid rgba(255, 0, 60, 0.3);
    box-shadow: 0 0 10px rgba(255, 0, 60, 0.3), 0 0 30px rgba(0, 150, 255, 0.2);
    backdrop-filter: blur(8px);
    border-radius: 1rem;
  }

  .saldo {
    font-size: 2rem;
    font-weight: 600;
    color: #00ffe1;
    text-shadow: 0 0 10px #00fff2;
  }

  .card-glow {
    background: rgba(25, 25, 35, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    transition: transform 0.3s, box-shadow 0.3s;
  }

  .card-glow:hover {
    transform: scale(1.03);
    box-shadow: 0 0 20px rgba(255, 0, 100, 0.5);
  }

  .btn-neon {
    background: linear-gradient(90deg, #ff003c, #ff6a00);
    border: none;
    color: #fff;
    font-weight: 600;
    transition: box-shadow 0.3s, transform 0.2s;
  }

  .btn-neon:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px #ff003c, 0 0 30px #ff6a00;
  }

  .glow {
    text-shadow: 0 0 10px #ff004c, 0 0 20px #ff004c;
  }

  .catalogo-container {
    margin-top: 2rem;
  }

  .platform-logo {
    border-radius: 0.75rem 0.75rem 0 0;
    height: 150px;
    object-fit: cover;
  }

  .table-neon {
    background: rgba(15, 15, 25, 0.7);
    border: 1px solid rgba(255, 0, 60, 0.3);
    box-shadow: 0 0 10px rgba(255, 0, 60, 0.3);
    border-radius: 1rem;
  }

  .table-neon th {
    color: #00eaff;
    text-shadow: 0 0 10px #00eaff;
  }

  .table-neon td {
    color: #eee;
  }

  .table-neon tbody tr:hover {
    background: rgba(255, 0, 80, 0.15);
  }

  hr {
    border-color: rgba(255, 255, 255, 0.1);
  }

  /* üéüÔ∏è Modal Ticket */
  #modalTicket {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #modalContent {
    background: #121212;
    color: #fff;
    padding: 25px;
    border-radius: 15px;
    width: 90%;
    max-width: 750px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 0 25px rgba(255,0,60,0.5);
    position: relative;
  }

  #cerrarModal {
    position: absolute;
    top: 10px; right: 15px;
    background: transparent;
    border: none;
    color: #ff003c;
    font-size: 22px;
    cursor: pointer;
    font-weight: bold;
  }

  .agotada {
    opacity: 0.6;
    filter: grayscale(70%);
  }
</style>

<div class="container mt-4">
  <h2 class="fw-bold mb-4 glow">Hola, <%= user.nombre %> ‚ú®</h2>
  <p class="text-secondary mb-4">Explora nuestras plataformas disponibles</p>

  <div class="row g-4">
    <!-- üßç Datos del usuario -->
    <div class="col-md-4">
      <div class="neon-box p-4 h-100">
        <h5 class="mb-3">Mis datos</h5>
        <p><strong>Nombre:</strong> <%= user.nombre %> <%= user.apellido %></p>
        <p><strong>Pa√≠s:</strong> <%= user.pais %></p>
        <p><strong>Correo:</strong> <%= user.correo %></p>
        <% if (user.telefono) { %>
          <p><strong>Tel√©fono:</strong> <%= user.telefono %></p>
        <% } %>
        <p class="saldo mt-3">Saldo: $<%= user.saldo %> MXN</p>
      </div>
    </div>

    <!-- üé¨ Cat√°logo -->
    <div class="col-md-8">
      <div class="catalogo-container">
        <h3 class="mb-3">Cat√°logo de plataformas</h3>
        <div class="row g-3">
          <% if (productos && productos.length) { %>
            <% productos.forEach(p => { %>
              <div class="col-6 col-lg-4">
                <div class="card card-glow h-100 text-center <%= p.cuposDisponibles === 0 ? 'agotada' : '' %>">
                  <% if (p.logo) { %>
                    <img src="<%= p.logo %>" alt="<%= p.nombre %>" class="platform-logo">
                  <% } %>
                  <div class="card-body">
                    <h6 class="text-light"><%= p.nombre %></h6>

                    <% if (p.cuposDisponibles > 0) { %>
                      <p class="text-success fw-bold mb-2"><%= p.cuposDisponibles %> cupos disponibles</p>
                      <a href="/plataforma/<%= p._id %>" class="btn btn-neon w-100">Explorar planes</a>
                    <% } else { %>
                      <p class="text-danger fw-bold mb-2">Agotado</p>
                      <button class="btn btn-secondary w-100" disabled>Sin cupos</button>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-secondary">No hay plataformas disponibles.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <hr class="my-5">

  <!-- üìÖ SUSCRIPCIONES ACTIVAS -->
  <div class="neon-box p-4 mt-4">
    <h3 class="mb-4 text-center">üìÖ Mis suscripciones activas</h3>

    <% if (subsActivas && subsActivas.length > 0) { %>
      <div class="table-responsive mb-5">
        <table class="table table-neon table-borderless align-middle text-center">
          <thead>
            <tr>
              <th>Plataforma</th>
              <th>Duraci√≥n</th>
              <th>Precio Pagado</th>
              <th>Vence En</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% subsActivas.forEach(s => { %>
              <tr>
                <td>
                  <% if (s.platformId && s.platformId.logoUrl) { %>
                    <img src="<%= s.platformId.logoUrl %>" alt="<%= s.platformId.name %>" style="height:40px; border-radius:6px;">
                    <br>
                    <small><%= s.platformId.name %></small>
                  <% } else { %>
                    <%= s.platformId ? s.platformId.name : 'N/A' %>
                  <% } %>
                </td>
                <td><%= s.meses %> mes<%= s.meses > 1 ? 'es' : '' %></td>
                <td>$<%= s.precio %> MXN</td>
                <td><%= dayjs(s.fechaFin).format('DD/MM/YYYY') %></td>
                <td><span class="badge bg-success">Activa</span></td>
                <td>
                  <button class="btn btn-sm btn-outline-danger" onclick="verTicket('<%= s._id %>')">
                    üéüÔ∏è Ver Ticket
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="text-secondary text-center mb-5">No tienes suscripciones activas.</p>
    <% } %>

    <!-- üìú HISTORIAL DE SUSCRIPCIONES VENCIDAS -->
    <h3 class="mb-4 text-center">üìú Historial de suscripciones vencidas</h3>

    <% if (subsInactivas && subsInactivas.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-neon table-borderless align-middle text-center">
          <thead>
            <tr>
              <th>Plataforma</th>
              <th>Duraci√≥n</th>
              <th>Precio Pagado</th>
              <th>Fecha de vencimiento</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% subsInactivas.forEach(s => { %>
              <tr style="opacity: 0.6;">
                <td>
                  <% if (s.platformId && s.platformId.logoUrl) { %>
                    <img src="<%= s.platformId.logoUrl %>" alt="<%= s.platformId.name %>" style="height:40px; border-radius:6px;">
                    <br>
                    <small><%= s.platformId.name %></small>
                  <% } else { %>
                    <%= s.platformId ? s.platformId.name : 'N/A' %>
                  <% } %>
                </td>
                <td><%= s.meses %> mes<%= s.meses > 1 ? 'es' : '' %></td>
                <td>$<%= s.precio %> MXN</td>
                <td><%= dayjs(s.fechaFin).format('DD/MM/YYYY') %></td>
                <td><span class="badge bg-secondary">Inactiva</span></td>
                <td>
                  <button class="btn btn-sm btn-outline-light" onclick="verTicket('<%= s._id %>')">
                    üéüÔ∏è Ver Ticket
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="text-secondary text-center">No tienes suscripciones vencidas a√∫n.</p>
    <% } %>
  </div>
</div>

<!-- üéüÔ∏è Modal de Ticket -->
<div id="modalTicket">
  <div id="modalContent">
    <button id="cerrarModal">&times;</button>
    <div id="contenidoTicket">Cargando...</div>
  </div>
</div>
<script>
const modal = document.getElementById('modalTicket');
const modalContent = document.getElementById('contenidoTicket');
const cerrar = document.getElementById('cerrarModal');

cerrar.addEventListener('click', () => modal.style.display = 'none');

async function verTicket(id) {
  modal.style.display = 'flex';
  modalContent.innerHTML = '<p style="text-align:center;">‚è≥ Cargando ticket...</p>';

  try {
    const res = await fetch(`/ticket/${id}`);
    const html = await res.text();
    modalContent.innerHTML = html;

    // üïê Esperar im√°genes cargadas antes de ajustar
    const imgs = modalContent.querySelectorAll('img');
    await Promise.all(Array.from(imgs).map(img => new Promise(resolve => {
      if (img.complete) return resolve();
      img.onload = resolve;
      img.onerror = resolve;
    })));

    // üé® Reajustar logos grandes (solo vista previa)
    imgs.forEach(img => {
      if (img.naturalWidth > 400 || img.naturalHeight > 150) {
        img.removeAttribute('style'); // elimina estilos inline del ticket
        img.style.setProperty('max-height', '120px', 'important');
        img.style.setProperty('width', 'auto', 'important');
        img.style.setProperty('height', 'auto', 'important');
        img.style.setProperty('display', 'block', 'important');
        img.style.setProperty('margin', '0 auto 10px', 'important');
        img.style.setProperty('object-fit', 'contain', 'important');
      }
    });

    // üîß Reinyectar los scripts del ticket (como html2pdf)
    const scripts = modalContent.querySelectorAll("script");
    scripts.forEach(oldScript => {
      const newScript = document.createElement("script");
      if (oldScript.src) newScript.src = oldScript.src;
      else newScript.textContent = oldScript.textContent;
      document.body.appendChild(newScript);
    });

  } catch (err) {
    console.error(err);
    modalContent.innerHTML = '<p style="color:red;text-align:center;">Error al cargar el ticket.</p>';
  }
}
</script>

