<%- include('../partials/errors') %>
<%- include('../partials/success') %>

<div class="container mt-4 text-light">
  <h1 class="mb-4">🎛️ Gestión de Cuentas</h1>

  <!-- ======================= -->
  <!-- FORMULARIO NUEVA CUENTA -->
  <!-- ======================= -->
  <div class="card bg-dark mb-4 border-secondary shadow">
    <div class="card-header border-secondary">
      <h5 class="mb-0">➕ Agregar nueva cuenta</h5>
    </div>
    <div class="card-body">
      <form action="/admin/cuentas" method="POST">
        <!-- ✅ Token CSRF -->
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />

        <div class="row g-3 align-items-center">
          <!-- Plataforma -->
          <div class="col-md-3">
            <label class="form-label">Plataforma</label>
            <select name="plataformaId" class="form-select bg-dark text-light border-secondary" required>
              <option value="">Seleccionar...</option>
              <% platforms.forEach(p => { %>
                <option value="<%= p._id %>" <%= filters.plataformaId == p._id ? 'selected' : '' %>>
                  <%= p.name || p.nombre %>
                </option>
              <% }) %>
            </select>
          </div>

          <!-- Correo -->
          <div class="col-md-3">
            <label class="form-label">Correo</label>
            <input
              type="email"
              name="correo"
              class="form-control bg-dark text-light border-secondary"
              placeholder="correo@ejemplo.com"
              required
            />
          </div>

          <!-- Contraseña -->
          <div class="col-md-3">
            <label class="form-label">Contraseña</label>
            <input
              type="text"
              name="password"
              class="form-control bg-dark text-light border-secondary"
              placeholder="********"
              required
            />
          </div>

          <!-- Cupos -->
          <div class="col-md-2">
            <label class="form-label">Cupos</label>
            <input
              type="number"
              name="cupos"
              min="1"
              value="1"
              class="form-control bg-dark text-light border-secondary"
              required
            />
          </div>

          <!-- Botón Guardar -->
          <div class="col-md-1 text-end">
            <button type="submit" class="btn btn-danger mt-4 w-100">
              Guardar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ==================== -->
  <!-- TABLA DE CUENTAS -->
  <!-- ==================== -->
  <div class="card bg-dark border-secondary shadow">
    <div class="card-header border-secondary d-flex justify-content-between align-items-center">
      <h5 class="mb-0">📋 Cuentas registradas</h5>

      <!-- FILTROS -->
      <form method="get" action="/admin/cuentas" class="d-flex align-items-center gap-2">
        <select
          name="plataformaId"
          class="form-select bg-dark text-light border-secondary"
          onchange="this.form.submit()"
        >
          <option value="all">Todas las plataformas</option>
          <% platforms.forEach(p => { %>
            <option value="<%= p._id %>" <%= filters.plataformaId == p._id ? 'selected' : '' %>>
              <%= p.name || p.nombre %>
            </option>
          <% }) %>
        </select>

        <input
          type="text"
          name="q"
          value="<%= filters.q %>"
          placeholder="Buscar correo..."
          class="form-control bg-dark text-light border-secondary"
        />
        <button type="submit" class="btn btn-warning">Filtrar</button>
      </form>
    </div>

    <!-- TABLA -->
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Plataforma</th>
              <th>Correo</th>
              <th>Contraseña</th>
              <th>Cupos</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% if (accounts.length === 0) { %>
              <tr>
                <td colspan="6" class="text-center text-secondary py-4">
                  No hay cuentas registradas
                </td>
              </tr>
            <% } else { %>
              <% accounts.forEach(acc => { %>
                <tr>
                  <!-- Plataforma -->
                  <td><%= acc.plataformaId ? (acc.plataformaId.name || acc.plataformaId.nombre) : 'Sin plataforma' %></td>

                  <!-- Correo -->
                  <td><%= acc.correo %></td>

                  <!-- Contraseña con toggle -->
                  <td>
                    <span class="password-mask" data-pass="<%= acc.password %>">•••••••</span>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-secondary btn-show-pass"
                      title="Mostrar contraseña"
                    >
                      👁️
                    </button>
                  </td>

                  <!-- Cupos -->
                  <td><%= acc.cupos %></td>

                  <!-- Estado -->
                  <td>
                    <% if (acc.activa) { %>
                      <span class="badge bg-success">Activa</span>
                    <% } else { %>
                      <span class="badge bg-secondary">Inactiva</span>
                    <% } %>
                  </td>

                  <!-- Acciones -->
                  <td>
                    <!-- ACTIVAR/DESACTIVAR -->
                    <form
                      action="/admin/cuentas/<%= acc._id %>/update"
                      method="POST"
                      class="d-inline"
                    >
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                      <input type="hidden" name="activa" value="<%= !acc.activa %>" />
                      <button
                        class="btn btn-sm <%= acc.activa ? 'btn-secondary' : 'btn-success' %>"
                      >
                        <%= acc.activa ? 'Desactivar' : 'Activar' %>
                      </button>
                    </form>

                    <!-- ELIMINAR -->
                    <form
                      action="/admin/cuentas/<%= acc._id %>/delete"
                      method="POST"
                      class="d-inline"
                    >
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                      <button
                        class="btn btn-sm btn-danger"
                        onclick="return confirm('¿Eliminar esta cuenta?')"
                      >
                        Eliminar
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ======================= -->
<!-- SCRIPT Mostrar contraseñas -->
<!-- ======================= -->
<script>
  document.querySelectorAll('.btn-show-pass').forEach(btn => {
    btn.addEventListener('click', () => {
      const span = btn.previousElementSibling;
      const hidden = span.textContent.includes('•');
      span.textContent = hidden ? span.dataset.pass : '•••••••';
      btn.textContent = hidden ? '🙈' : '👁️';
    });
  });
</script>
