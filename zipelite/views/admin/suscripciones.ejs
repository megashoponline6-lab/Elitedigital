<% layout = 'admin/layout' %>
<% var title = 'Dashboard de Suscripciones'; %>

<style>
  body {
    background-color: #0e0e12;
    color: #e0e0e0;
  }

  h2 {
    color: #fff;
  }

  .panel-box {
    background: #1b1b22;
    border: 1px solid #2a2a33;
    border-radius: 0.75rem;
    padding: 1.5rem;
  }

  .table-clean {
    width: 100%;
    background: #181820;
    border-collapse: collapse;
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .table-clean th {
    color: #00c8ff;
    background: #20202a;
    padding: 0.75rem;
    text-align: center;
  }

  .table-clean td {
    color: #ddd;
    padding: 0.75rem;
    text-align: center;
    border-top: 1px solid #2a2a33;
  }

  .table-clean tr:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .badge {
    padding: 0.35em 0.7em;
    border-radius: 0.5em;
    font-weight: 600;
  }

  .bg-success { background: #28a745; color: #fff; }
  .bg-danger { background: #dc3545; color: #fff; }

  .platform-logo {
    height: 40px;
    border-radius: 6px;
  }

  .user-email {
    color: #00c8ff;
  }

  .btn-primary-custom {
    background: #ff003c;
    border: none;
    color: #fff;
    padding: 0.6rem 1.2rem;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: transform 0.2s, box-shadow 0.3s;
    text-decoration: none;
  }

  .btn-primary-custom:hover {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(255, 0, 60, 0.4);
  }

  .btn-ticket {
    background: #00c8ff;
    color: #000;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 0.4rem;
    font-weight: 600;
    transition: all 0.2s;
    text-decoration: none;
  }

  .btn-ticket:hover {
    background: #00a3d6;
    color: #fff;
    transform: scale(1.05);
  }

  /* üîç Barra de b√∫squeda */
  .search-bar {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .search-input {
    flex: 1;
    background: #1e1e28;
    border: 1px solid #333;
    border-radius: 0.5rem;
    color: #fff;
    padding: 0.6rem 1rem;
    font-size: 1rem;
  }

  .search-input:focus {
    outline: none;
    border-color: #ff003c;
  }

  .contador {
    font-size: 0.95rem;
    color: #aaa;
  }

  .toggle-btn {
    background: #1b1b22;
    border: 1px solid #00c8ff;
    color: #00c8ff;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: 0.3s;
  }

  .toggle-btn:hover {
    background: rgba(0, 200, 255, 0.2);
  }

  /* üéüÔ∏è Modal personalizado */
  #ticketModal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    justify-content: center;
    align-items: center;
  }

  #ticketModal .modal-content {
    background: #121217;
    color: #fff;
    border-radius: 0.75rem;
    padding: 1rem;
    width: 95%;
    max-width: 750px;
    max-height: 90%;
    overflow-y: auto;
    box-shadow: 0 0 25px rgba(0, 200, 255, 0.25);
    animation: fadeIn 0.3s ease;
    position: relative;
  }

  #ticketModal .close {
    float: right;
    font-size: 1.6rem;
    font-weight: bold;
    color: #ff003c;
    cursor: pointer;
  }

  @keyframes fadeIn {
    from {opacity: 0; transform: scale(0.9);}
    to {opacity: 1; transform: scale(1);}
  }

  #ticketModal iframe {
    width: 100%;
    height: 80vh;
    border: none;
    border-radius: 0.5rem;
    background: #fff;
  }

  /* üåÄ Loader animado */
  #loader {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    color: #00c8ff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 600;
    font-size: 1.1rem;
    border-radius: 0.75rem;
    z-index: 10;
    flex-direction: column;
  }

  .spinner {
    border: 4px solid rgba(255,255,255,0.1);
    border-left-color: #00c8ff;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    margin-bottom: 10px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2 class="fw-bold mb-3 mb-md-0">üìä Suscripciones registradas</h2>
    <a href="/admin/panel" class="btn-primary-custom">‚¨Ö Volver al Panel</a>
  </div>

  <!-- üîç Barra de b√∫squeda + controles -->
  <div class="search-bar">
    <input
      type="text"
      id="buscador"
      class="search-input"
      placeholder="Buscar por usuario, correo o plataforma..."
    />
    <button id="toggleVencidas" class="toggle-btn">Mostrar vencidas</button>
    <span id="contador" class="contador">
      Mostrando <%= subs.filter(s => s.activa).length %> de <%= subs.length %>
    </span>
  </div>

  <div class="panel-box">
    <% if (subs && subs.length > 0) { %>
      <div class="table-responsive">
        <table class="table-clean" id="tablaSubs">
          <thead>
            <tr>
              <th>#</th>
              <th>Usuario</th>
              <th>Correo</th>
              <th>Plataforma</th>
              <th>Duraci√≥n</th>
              <th>Precio</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Estado</th>
              <th>üìß Cuenta Asignada</th>
              <th>üîí Contrase√±a</th>
              <th>üéüÔ∏è Ticket</th>
            </tr>
          </thead>
          <tbody>
            <% subs.forEach((s, i) => { %>
              <tr class="<%= s.activa ? 'activa' : 'vencida' %>">
                <td><%= i + 1 %></td>
                <td><%= s.userId ? (s.userId.nombre + ' ' + (s.userId.apellido || '')) : 'N/A' %></td>
                <td><small class="user-email"><%= s.userId ? s.userId.correo : 'N/A' %></small></td>
                <td>
                  <% if (s.platformId && s.platformId.logoUrl) { %>
                    <img src="<%= s.platformId.logoUrl %>" alt="<%= s.platformId.name %>" class="platform-logo"><br>
                  <% } %>
                  <%= s.platformId ? s.platformId.name : 'N/A' %>
                </td>
                <td><%= s.meses %> mes<%= s.meses > 1 ? 'es' : '' %></td>
                <td>$<%= s.precio %> MXN</td>
                <td><%= dayjs(s.fechaInicio).format('DD/MM/YYYY') %></td>
                <td><%= dayjs(s.fechaFin).format('DD/MM/YYYY') %></td>
                <td>
                  <% if (s.activa) { %>
                    <span class="badge bg-success">Activa</span>
                  <% } else { %>
                    <span class="badge bg-danger">Vencida</span>
                  <% } %>
                </td>
                <td>
                  <% if (s.datosCuenta?.correo) { %>
                    <code><%= s.datosCuenta.correo %></code>
                  <% } else { %>
                    <em class="text-muted">Sin asignar</em>
                  <% } %>
                </td>
                <td>
                  <% if (s.datosCuenta?.password) { %>
                    <code><%= s.datosCuenta.password %></code>
                  <% } else { %>
                    <em class="text-muted">N/A</em>
                  <% } %>
                </td>
                <td>
                  <button class="btn-ticket" onclick="verTicket('<%= s._id %>')">Ver Ticket</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="text-center text-secondary mt-3">No hay suscripciones registradas a√∫n.</p>
    <% } %>
  </div>
</div>

<!-- üéüÔ∏è Modal Ticket -->
<div id="ticketModal">
  <div class="modal-content">
    <span class="close" onclick="cerrarTicket()">&times;</span>
    <div id="loader">
      <div class="spinner"></div>
      Cargando ticket‚Ä¶
    </div>
    <iframe id="ticketFrame" src=""></iframe>
  </div>
</div>

<script>
  const buscador = document.getElementById('buscador');
  const filas = document.querySelectorAll('#tablaSubs tbody tr');
  const contador = document.getElementById('contador');
  const total = filas.length;
  const toggleBtn = document.getElementById('toggleVencidas');
  let mostrarVencidas = false;

  filas.forEach(f => {
    if (f.classList.contains('vencida')) f.style.display = 'none';
  });

  function actualizarContador() {
    const visibles = Array.from(filas).filter(f => f.style.display !== 'none').length;
    contador.textContent = `Mostrando ${visibles} de ${total}`;
  }

  buscador.addEventListener('keyup', () => {
    const texto = buscador.value.toLowerCase();
    filas.forEach(fila => {
      const contenido = fila.textContent.toLowerCase();
      const coincide = contenido.includes(texto);
      const esVencida = fila.classList.contains('vencida');
      fila.style.display = coincide && (mostrarVencidas || !esVencida) ? '' : 'none';
    });
    actualizarContador();
  });

  toggleBtn.addEventListener('click', () => {
    mostrarVencidas = !mostrarVencidas;
    toggleBtn.textContent = mostrarVencidas ? 'Ocultar vencidas' : 'Mostrar vencidas';
    filas.forEach(f => {
      const esVencida = f.classList.contains('vencida');
      if (esVencida) f.style.display = mostrarVencidas ? '' : 'none';
    });
    actualizarContador();
  });

  actualizarContador();

  const ticketModal = document.getElementById('ticketModal');
  const ticketFrame = document.getElementById('ticketFrame');
  const loader = document.getElementById('loader');

  function verTicket(id) {
    ticketFrame.src = `/ticket/${id}`;
    ticketModal.style.display = 'flex';
    loader.style.display = 'flex';
    ticketFrame.onload = () => {
      loader.style.display = 'none';
    };
  }

  function cerrarTicket() {
    ticketModal.style.display = 'none';
    ticketFrame.src = '';
  }

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') cerrarTicket();
  });

  window.addEventListener('click', (e) => {
    if (e.target === ticketModal) cerrarTicket();
  });
</script>
