<% layout = 'admin/layout' %>
<% var title = 'Dashboard de Suscripciones'; %>

<style>
  body {
    background-color: #0e0e12;
    color: #e0e0e0;
  }

  h2 {
    color: #fff;
  }

  .panel-box {
    background: #1b1b22;
    border: 1px solid #2a2a33;
    border-radius: 0.75rem;
    padding: 1.5rem;
  }

  .table-clean {
    width: 100%;
    background: #181820;
    border-collapse: collapse;
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .table-clean th {
    color: #00c8ff;
    background: #20202a;
    padding: 0.75rem;
    text-align: center;
  }

  .table-clean td {
    color: #ddd;
    padding: 0.75rem;
    text-align: center;
    border-top: 1px solid #2a2a33;
  }

  .table-clean tr:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .badge {
    padding: 0.35em 0.7em;
    border-radius: 0.5em;
    font-weight: 600;
  }

  .bg-success { background: #28a745; color: #fff; }
  .bg-danger { background: #dc3545; color: #fff; }

  .platform-logo {
    height: 40px;
    border-radius: 6px;
  }

  .user-email {
    color: #00c8ff;
  }

  .btn-primary-custom {
    background: #ff003c;
    border: none;
    color: #fff;
    padding: 0.6rem 1.2rem;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: transform 0.2s, box-shadow 0.3s;
    text-decoration: none;
  }

  .btn-primary-custom:hover {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(255, 0, 60, 0.4);
  }

  /* üîç Barra de b√∫squeda */
  .search-bar {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .search-input {
    flex: 1;
    background: #1e1e28;
    border: 1px solid #333;
    border-radius: 0.5rem;
    color: #fff;
    padding: 0.6rem 1rem;
    font-size: 1rem;
  }

  .search-input:focus {
    outline: none;
    border-color: #ff003c;
  }

  .contador {
    font-size: 0.95rem;
    color: #aaa;
  }

  .toggle-btn {
    background: #1b1b22;
    border: 1px solid #00c8ff;
    color: #00c8ff;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: 0.3s;
  }

  .toggle-btn:hover {
    background: rgba(0, 200, 255, 0.2);
  }
</style>

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2 class="fw-bold mb-3 mb-md-0">üìä Suscripciones registradas</h2>
    <a href="/admin/panel" class="btn-primary-custom">‚¨Ö Volver al Panel</a>
  </div>

  <!-- üîç Barra de b√∫squeda + controles -->
  <div class="search-bar">
    <input
      type="text"
      id="buscador"
      class="search-input"
      placeholder="Buscar por usuario, correo o plataforma..."
    />
    <button id="toggleVencidas" class="toggle-btn">Mostrar vencidas</button>
    <span id="contador" class="contador">
      Mostrando <%= subs.filter(s => s.activa).length %> de <%= subs.length %>
    </span>
  </div>

  <div class="panel-box">
    <% if (subs && subs.length > 0) { %>
      <div class="table-responsive">
        <table class="table-clean" id="tablaSubs">
          <thead>
            <tr>
              <th>#</th>
              <th>Usuario</th>
              <th>Correo</th>
              <th>Plataforma</th>
              <th>Duraci√≥n</th>
              <th>Precio</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <% subs.forEach((s, i) => { %>
              <tr class="<%= s.activa ? 'activa' : 'vencida' %>">
                <td><%= i + 1 %></td>
                <td><%= s.userId ? (s.userId.nombre + ' ' + (s.userId.apellido || '')) : 'N/A' %></td>
                <td><small class="user-email"><%= s.userId ? s.userId.correo : 'N/A' %></small></td>
                <td>
                  <% if (s.platformId && s.platformId.logoUrl) { %>
                    <img src="<%= s.platformId.logoUrl %>" alt="<%= s.platformId.name %>" class="platform-logo"><br>
                  <% } %>
                  <%= s.platformId ? s.platformId.name : 'N/A' %>
                </td>
                <td><%= s.meses %> mes<%= s.meses > 1 ? 'es' : '' %></td>
                <td>$<%= s.precio %> MXN</td>
                <td><%= dayjs(s.fechaInicio).format('DD/MM/YYYY') %></td>
                <td><%= dayjs(s.fechaFin).format('DD/MM/YYYY') %></td>
                <td>
                  <% if (s.activa) { %>
                    <span class="badge bg-success">Activa</span>
                  <% } else { %>
                    <span class="badge bg-danger">Vencida</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="text-center text-secondary mt-3">No hay suscripciones registradas a√∫n.</p>
    <% } %>
  </div>
</div>

<script>
  const buscador = document.getElementById('buscador');
  const filas = document.querySelectorAll('#tablaSubs tbody tr');
  const contador = document.getElementById('contador');
  const total = filas.length;
  const toggleBtn = document.getElementById('toggleVencidas');
  let mostrarVencidas = false;

  // Ocultar las vencidas al cargar
  filas.forEach(f => {
    if (f.classList.contains('vencida')) f.style.display = 'none';
  });

  function actualizarContador() {
    const visibles = Array.from(filas).filter(f => f.style.display !== 'none').length;
    contador.textContent = `Mostrando ${visibles} de ${total}`;
  }

  buscador.addEventListener('keyup', () => {
    const texto = buscador.value.toLowerCase();
    filas.forEach(fila => {
      const contenido = fila.textContent.toLowerCase();
      const coincide = contenido.includes(texto);
      const esVencida = fila.classList.contains('vencida');
      fila.style.display = coincide && (mostrarVencidas || !esVencida) ? '' : 'none';
    });
    actualizarContador();
  });

  toggleBtn.addEventListener('click', () => {
    mostrarVencidas = !mostrarVencidas;
    toggleBtn.textContent = mostrarVencidas ? 'Ocultar vencidas' : 'Mostrar vencidas';
    filas.forEach(f => {
      const esVencida = f.classList.contains('vencida');
      if (esVencida) f.style.display = mostrarVencidas ? '' : 'none';
    });
    actualizarContador();
  });

  actualizarContador();
</script>
