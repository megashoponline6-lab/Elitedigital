<%- include('../partials/errors') %>
<%- include('../partials/success') %>

<div class="container mt-4 text-light">
  <h1 class="mb-4">ðŸŽ¬ GestiÃ³n de Plataformas</h1>

  <!-- ============================== -->
  <!-- FORMULARIO NUEVA PLATAFORMA -->
  <!-- ============================== -->
  <div class="card bg-dark border-secondary mb-4 shadow">
    <div class="card-header border-secondary">
      <h5 class="mb-0">âž• AÃ±adir nueva plataforma</h5>
    </div>
    <div class="card-body">
      <form action="/admin/plataformas" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div class="row g-3 align-items-center">
          <div class="col-md-5">
            <label class="form-label">Nombre de la plataforma</label>
            <input
              type="text"
              name="name"
              class="form-control bg-dark text-light border-secondary"
              placeholder="Netflix, Disney+, etc."
              required
            />
          </div>

          <div class="col-md-5">
            <label class="form-label">Logo (ruta o nombre del archivo)</label>
            <input
              type="text"
              name="logoUrl"
              class="form-control bg-dark text-light border-secondary"
              placeholder="/img/plataformas/netflix.png"
            />
            <small class="text-secondary">Los logos deben estar en /public/img/plataformas/</small>
          </div>

          <div class="col-md-2">
            <button class="btn btn-danger mt-4 w-100">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ============================== -->
  <!-- TABLA DE PLATAFORMAS -->
  <!-- ============================== -->
  <div class="card bg-dark border-secondary shadow">
    <div class="card-header border-secondary">
      <h5 class="mb-0">ðŸ“‹ Plataformas registradas</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Logo</th>
              <th>Nombre</th>
              <th>Disponible</th>
              <th>Actualizar logo / ruta</th>
              <th>ðŸ’° Precios (1,3,6,12M)</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% if (platforms.length === 0) { %>
              <tr>
                <td colspan="6" class="text-center text-secondary py-4">
                  No hay plataformas registradas
                </td>
              </tr>
            <% } else { %>
              <% platforms.forEach(p => { %>
                <tr>
                  <td>
                    <% if (p.logoUrl) { %>
                      <img src="/<%= p.logoUrl.replace(/^\/?/, '') %>" style="height:40px; border-radius:8px;" alt="Logo <%= p.name %>" />
                    <% } else { %>
                      <span class="text-secondary">Sin logo</span>
                    <% } %>
                  </td>

                  <td><strong><%= p.name %></strong></td>

                  <td>
                    <% if (p.available) { %>
                      <span class="badge bg-success">SÃ­</span>
                    <% } else { %>
                      <span class="badge bg-secondary">No</span>
                    <% } %>
                  </td>

                  <!-- Logo / ruta -->
                  <td>
                    <form
                      action="/admin/plataformas/<%= p._id %>/update"
                      method="POST"
                      class="d-flex align-items-center gap-2"
                    >
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <input
                        type="text"
                        name="logoUrl"
                        value="<%= p.logoUrl || '' %>"
                        class="form-control form-control-sm bg-dark text-light"
                        placeholder="/img/plataformas/netflix.png"
                      />
                      <button class="btn btn-sm btn-outline-warning">Actualizar</button>
                    </form>
                  </td>

                  <!-- ðŸ’° Editar precios -->
                  <td>
                    <form action="/admin/plataformas/<%= p._id %>/precios" method="POST" class="d-flex flex-column gap-1">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <div class="input-group input-group-sm">
                        <span class="input-group-text bg-dark text-light border-secondary">1M</span>
                        <input type="number" name="mes1" value="<%= p.precios?.[1] || '' %>" class="form-control bg-dark text-light border-secondary">
                      </div>
                      <div class="input-group input-group-sm">
                        <span class="input-group-text bg-dark text-light border-secondary">3M</span>
                        <input type="number" name="mes3" value="<%= p.precios?.[3] || '' %>" class="form-control bg-dark text-light border-secondary">
                      </div>
                      <div class="input-group input-group-sm">
                        <span class="input-group-text bg-dark text-light border-secondary">6M</span>
                        <input type="number" name="mes6" value="<%= p.precios?.[6] || '' %>" class="form-control bg-dark text-light border-secondary">
                      </div>
                      <div class="input-group input-group-sm">
                        <span class="input-group-text bg-dark text-light border-secondary">12M</span>
                        <input type="number" name="mes12" value="<%= p.precios?.[12] || '' %>" class="form-control bg-dark text-light border-secondary">
                      </div>
                      <button class="btn btn-sm btn-outline-info mt-1">Guardar</button>
                    </form>
                  </td>

                  <!-- Eliminar -->
                  <td>
                    <form action="/admin/plataformas/<%= p._id %>/delete" method="POST" onsubmit="return confirm('Â¿Eliminar esta plataforma?')">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
