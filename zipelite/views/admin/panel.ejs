<% var title = 'Panel Admin'; %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Panel de Administración</h2>
  <div>
    <a href="/admin/cambiar-password" class="btn btn-warning me-2">Cambiar contraseña</a>
    <a href="/admin/salir" class="btn btn-outline-light">Salir</a>
  </div>
</div>

<div class="row g-4 mt-1">
  <!-- 🧾 RESUMEN -->
  <div class="col-lg-6">
    <div class="card bg-black border-secondary rounded-4">
      <div class="card-body">
        <h5>Resumen</h5>
        <div class="row text-center">
          <div class="col">
            <div class="h4">$<%= (totSaldo && totSaldo.s) ? totSaldo.s : 0 %></div>
            <div class="text-secondary small">Saldo total clientes</div>
          </div>
          <div class="col">
            <div class="h4">$<%= (totManualMes && totManualMes.s) ? totManualMes.s : 0 %></div>
            <div class="text-secondary small">Ventas manuales (mes)</div>
          </div>
          <div class="col">
            <div class="h4"><%= (totSubsAct && totSubsAct.c) ? totSubsAct.c : 0 %></div>
            <div class="text-secondary small">Subs activas</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 💰 RECARGAR SALDO -->
  <div class="col-lg-6">
    <div class="card bg-black border-secondary rounded-4">
      <div class="card-body">
        <h5>Recargar saldo</h5>

        <!-- 🔧 FORMULARIO CORREGIDO -->
        <form class="row g-2" method="POST" action="/admin/recargar">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">

          <div class="col-md-3">
            <input class="form-control" name="user_id" type="number" placeholder="ID Usuario" required>
          </div>
          <div class="col-md-3">
            <input class="form-control" name="monto" type="number" min="1" placeholder="Monto" required>
          </div>
          <div class="col-md-4">
            <input class="form-control" name="nota" placeholder="Nota (opcional)">
          </div>
          <div class="col-md-2">
            <button class="btn btn-danger w-100">Cargar</button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <!-- 👥 USUARIOS -->
  <div class="col-lg-12">
    <div class="card bg-black border-secondary rounded-4">
      <div class="card-body">
        <h5>Usuarios recientes</h5>
        <table class="table table-dark table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th><th>Nombre</th><th>Correo</th><th>Saldo</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% usuarios.forEach(u => { %>
              <tr>
                <td><%= u.id %></td>
                <td><%= u.nombre %> <%= u.apellido %></td>
                <td><%= u.correo %></td>
                <td>$<%= u.saldo %></td>
                <td>
                  <form class="d-inline" method="POST" action="/admin/cliente/<%= u.id %>/eliminar" onsubmit="return confirm('¿Eliminar cliente?')">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 🛍 PRODUCTOS -->
  <div class="col-lg-12">
    <div class="card bg-black border-secondary rounded-4">
      <div class="card-body">
        <h5>Productos</h5>

        <form class="row g-2 mb-3" method="POST" action="/admin/producto" enctype="multipart/form-data">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <div class="col-md-4">
            <input class="form-control" name="nombre" placeholder="Nombre">
          </div>
          <div class="col-md-2">
            <select class="form-select" name="etiqueta">
              <option>1M</option>
              <option>2M</option>
              <option>3M</option>
              <option>6M</option>
              <option>Anual</option>
              <option>Completa</option>
            </select>
          </div>
          <div class="col-md-2">
            <input class="form-control" name="precio" type="number" placeholder="Precio">
          </div>
          <div class="col-md-2">
            <input class="form-control" name="logo" placeholder="Emoji (opcional)">
          </div>
          <div class="col-md-2">
            <input class="form-control" type="file" name="logoimg" accept="image/*">
          </div>
          <div class="col-12">
            <button class="btn btn-danger">Añadir</button>
          </div>
        </form>

        <table class="table table-dark table-sm align-middle">
          <thead>
            <tr><th>ID</th><th>Logo</th><th>Nombre</th><th>Etiqueta</th><th>Precio</th><th>Activo</th><th>Acciones</th></tr>
          </thead>
          <tbody>
            <% productos.forEach(p => { %>
              <tr>
                <td><%= p.id %></td>
                <td><% if (p.logo) { %><img src="<%= p.logo %>" style="height:28px"><% } %></td>
                <td><%= p.nombre %></td>
                <td><%= p.etiqueta %></td>
                <td>$<%= p.precio %></td>
                <td><%= p.activo ? 'Sí' : 'No' %></td>
                <td>
                  <form class="d-inline" method="POST" action="/admin/producto/<%= p.id %>/editar" enctype="multipart/form-data">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="hidden" name="nombre" value="<%= p.nombre %>">
                    <input type="hidden" name="etiqueta" value="<%= p.etiqueta %>">
                    <input type="hidden" name="precio" value="<%= p.precio %>">
                    <input type="hidden" name="logo" value="<%= p.logo %>">
                    <input type="hidden" name="activo" value="<%= p.activo ? 0 : 1 %>">
                    <button class="btn btn-sm btn-outline-light">Activar/Desactivar</button>
                  </form>

                  <form class="d-inline" method="POST" action="/admin/producto/<%= p.id %>/eliminar" onsubmit="return confirm('¿Eliminar producto?')">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
