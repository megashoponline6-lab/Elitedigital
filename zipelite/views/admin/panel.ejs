<% var title = 'Panel Admin'; %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Panel de Administraci√≥n</h2>
  <div>
    <a href="/admin/cambiar-password" class="btn btn-warning me-2">Cambiar contrase√±a</a>
    <a href="/admin/salir" class="btn btn-outline-light">Salir</a>
  </div>
</div>

<div class="row g-4 mt-1">

  <!-- üßæ RESUMEN -->
  <div class="col-lg-6">
    <div class="card bg-black border-secondary rounded-4">
      <div class="card-body">
        <h5>Resumen</h5>
        <div class="row text-center">
          <div class="col">
            <div class="h4">$<%= (totSaldo && totSaldo.s) ? totSaldo.s : 0 %></div>
            <div class="text-secondary small">Saldo total clientes</div>
          </div>
          <div class="col">
            <div class="h4">$<%= (totManualMes && totManualMes.s) ? totManualMes.s : 0 %></div>
            <div class="text-secondary small">Ventas manuales (mes)</div>
          </div>
          <div class="col">
            <div class="h4"><%= (totSubsAct && totSubsAct.c) ? totSubsAct.c : 0 %></div>
            <div class="text-secondary small">Subs activas</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üí∞ RECARGAR SALDO -->
  <div class="col-lg-6">
    <div class="card bg-black border-secondary rounded-4">
      <div class="card-body">
        <h5>Recargar saldo</h5>
        <form class="row g-2" method="POST" action="/admin/recargar">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <div class="col-md-4">
            <input class="form-control" name="correo" type="email" placeholder="Correo del usuario" required>
          </div>
          <div class="col-md-3">
            <input class="form-control" name="monto" type="number" min="1" placeholder="Monto" required>
          </div>
          <div class="col-md-3">
            <input class="form-control" name="nota" placeholder="Nota (opcional)">
          </div>
          <div class="col-md-2">
            <button class="btn btn-danger w-100">Cargar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- üë• USUARIOS -->
  <div class="col-lg-12">
    <div class="card bg-black border-secondary rounded-4">
      <div class="card-body">
        <h5>Usuarios recientes</h5>
        <table class="table table-dark table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Correo</th>
              <th>Saldo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% usuarios.forEach(u => { %>
              <tr>
                <td><%= u.id %></td>
                <td><%= u.nombre %> <%= u.apellido %></td>
                <td><%= u.correo %></td>
                <td>$<%= u.saldo %></td>
                <td>
                  <form class="d-inline" method="POST" action="/admin/cliente/<%= u.id %>/eliminar" onsubmit="return confirm('¬øEliminar cliente?')">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- üé¨ PLATAFORMAS -->
  <div class="col-lg-12">
    <div class="card bg-black border-secondary rounded-4">
      <div class="card-body">
        <h5>Plataformas de Streaming</h5>

        <!-- ‚ûï A√±adir nueva plataforma -->
        <form class="row g-2 mb-3" method="POST" action="/admin/plataforma" enctype="multipart/form-data">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <div class="col-md-8">
            <input class="form-control" name="nombre" placeholder="Nombre del servicio (ej. Netflix)" required>
          </div>
          <div class="col-md-2">
            <input class="form-control" type="file" name="logoimg" accept="image/*">
          </div>
          <div class="col-md-2">
            <button class="btn btn-danger w-100">A√±adir</button>
          </div>
        </form>

        <!-- üßæ Tabla de plataformas -->
        <table class="table table-dark table-sm align-middle">
          <thead>
            <tr>
              <th>Logo</th>
              <th>Nombre</th>
              <th>Disponible</th>
              <th>Cambiar logo</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <% productos.forEach(p => { %>
              <tr>
                <td>
                  <% if (p.logo) { %>
                    <img src="<%= p.logo %>" style="height:40px; border-radius:8px">
                  <% } else { %>
                    <span class="text-secondary">Sin logo</span>
                  <% } %>
                </td>
                <td class="fw-bold"><%= p.nombre %></td>

                <!-- Mostrar si hay cuentas disponibles -->
                <td>
                  <% if (p.disponible) { %>
                    <span class="text-success fw-bold">S√≠</span>
                  <% } else { %>
                    <span class="text-danger fw-bold">No</span>
                  <% } %>
                </td>

                <!-- Cambiar logo -->
                <td>
                  <form method="POST" action="/admin/plataforma/<%= p.id %>/logo" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="file" name="logoimg" accept="image/*" class="form-control form-control-sm bg-dark text-light" required>
                    <button class="btn btn-sm btn-outline-warning">Actualizar</button>
                  </form>
                </td>

                <!-- Eliminar -->
                <td>
                  <form method="POST" action="/admin/plataforma/<%= p.id %>/eliminar" onsubmit="return confirm('¬øEliminar esta plataforma?')">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
